<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.innersignature.backend.mapper.CompanyMapper">
    <select id="findByCode" resultType="com.innersignature.backend.dto.CompanyDto">
        SELECT * FROM company_tb
        WHERE company_code = #{companyCode}
        LIMIT 1
    </select>
    
    <select id="findById" resultType="com.innersignature.backend.dto.CompanyDto">
        SELECT * FROM company_tb
        WHERE company_id = #{companyId}
        LIMIT 1
    </select>
    
    <select id="findByCreatedBy" resultType="com.innersignature.backend.dto.CompanyDto">
        SELECT * FROM company_tb
        WHERE created_by = #{adminUserId}
        AND is_active = 1
        ORDER BY created_at DESC
    </select>
    
    <select id="searchByName" resultType="com.innersignature.backend.dto.CompanySearchResultDto">
        SELECT 
            c.company_id AS companyId,
            c.company_name AS companyName,
            c.business_reg_no AS businessRegNo,
            c.representative_name AS representativeName,
            MAX(u.korean_name) AS adminName,
            CASE 
                WHEN c.company_name = #{companyName} THEN 1
                WHEN c.company_name LIKE CONCAT(#{companyName}, '%') THEN 2
                WHEN c.company_name LIKE CONCAT('%', #{companyName}, '%') THEN 3
                ELSE 4
            END AS matchPriority
        FROM company_tb c
        LEFT JOIN user_tb u ON c.created_by = u.user_id AND u.role = 'ADMIN'
        WHERE (
            c.company_name LIKE CONCAT('%', #{companyName}, '%')
            OR REPLACE(c.business_reg_no, '-', '') LIKE CONCAT('%', REPLACE(#{companyName}, '-', ''), '%')
        )
        AND c.is_active = 1
        GROUP BY c.company_id, c.company_name, c.business_reg_no, c.representative_name
        ORDER BY matchPriority ASC, c.company_name ASC
        LIMIT 20
    </select>
    
    <insert id="insert" parameterType="com.innersignature.backend.dto.CompanyDto" useGeneratedKeys="true" keyProperty="companyId">
        INSERT INTO company_tb (company_code, company_name, business_reg_no, representative_name, created_by, is_active, created_at, updated_at)
        VALUES (#{companyCode}, #{companyName}, #{businessRegNo}, #{representativeName}, #{createdBy}, #{isActive}, #{createdAt}, #{updatedAt})
    </insert>
    
    <select id="existsByCode" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM company_tb
        WHERE company_code = #{companyCode}
    </select>
    
    <select id="existsByBusinessRegNo" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM company_tb
        WHERE business_reg_no = #{businessRegNo}
    </select>
    
    <update id="updateSubscriptionId">
        UPDATE company_tb
        SET subscription_id = #{subscriptionId}
        WHERE company_id = #{companyId}
    </update>
    
    <update id="updateIsActive">
        UPDATE company_tb
        SET is_active = #{isActive}
        WHERE company_id = #{companyId}
    </update>
    
    <select id="findAll" resultType="com.innersignature.backend.dto.CompanyDto">
        SELECT * FROM company_tb
        ORDER BY created_at DESC
    </select>
</mapper>
