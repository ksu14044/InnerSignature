<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.innersignature.backend.mapper.ExpenseMapper">

    <select id="selectExpenseList" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT 
            r.*, 
            u.korean_name AS drafterName,
            (SELECT d.description
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != ''
             ORDER BY d.expense_detail_id ASC
             LIMIT 1) AS firstDescription,
            (SELECT COUNT(*)
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != '') AS descriptionCount
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        WHERE r.company_id = #{companyId}
        ORDER BY r.expense_report_id DESC
    </select>

    <select id="selectExpenseListWithPagination" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT 
            r.*, 
            u.korean_name AS drafterName,
            (SELECT d.description
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != ''
             ORDER BY d.expense_detail_id ASC
             LIMIT 1) AS firstDescription,
            (SELECT COUNT(*)
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != '') AS descriptionCount
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        WHERE r.company_id = #{companyId}
        ORDER BY r.expense_report_id DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countExpenseList" resultType="long">
        SELECT COUNT(*)
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        WHERE r.company_id = #{companyId}
    </select>

    <select id="selectExpenseListWithFilters" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT 
            r.*, 
            u.korean_name AS drafterName,
            (SELECT MAX(al.approval_date) 
             FROM approval_line_tb al 
             WHERE al.expense_report_id = r.expense_report_id 
               AND al.status = 'APPROVED'
               AND al.company_id = r.company_id) AS finalApprovalDate,
            (SELECT MIN(d.payment_req_date)
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.payment_req_date IS NOT NULL) AS minPaymentReqDate,
            (SELECT d.description
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != ''
             ORDER BY d.expense_detail_id ASC
             LIMIT 1) AS firstDescription,
            (SELECT COUNT(*)
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != '') AS descriptionCount
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        <where>
            r.company_id = #{companyId}
            <if test="startDate != null">
                AND r.report_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND r.report_date &lt;= #{endDate}
            </if>
            <if test="minAmount != null">
                AND r.total_amount &gt;= #{minAmount}
            </if>
            <if test="maxAmount != null">
                AND r.total_amount &lt;= #{maxAmount}
            </if>
            <if test="statuses != null and statuses.size() > 0">
                AND r.status IN
                <foreach collection="statuses" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="category != null and category != ''">
                AND EXISTS (
                    SELECT 1 FROM expense_detail_tb d
                    WHERE d.expense_report_id = r.expense_report_id
                      AND d.category = #{category}
                      AND d.company_id = r.company_id
                )
            </if>
            <if test="taxProcessed != null">
                AND r.tax_processed = #{taxProcessed}
            </if>
            <if test="drafterName != null and drafterName != ''">
                AND u.korean_name LIKE CONCAT('%', #{drafterName}, '%')
            </if>
            <if test="paymentMethod != null and paymentMethod != ''">
                AND EXISTS (
                    SELECT 1 FROM expense_detail_tb d
                    WHERE d.expense_report_id = r.expense_report_id
                      AND d.payment_method = #{paymentMethod}
                      AND d.company_id = r.company_id
                )
            </if>
        </where>
        ORDER BY 
            COALESCE((SELECT MIN(d.payment_req_date)
                      FROM expense_detail_tb d
                      WHERE d.expense_report_id = r.expense_report_id
                        AND d.company_id = r.company_id
                        AND d.payment_req_date IS NOT NULL), r.payment_req_date, r.report_date) DESC,
            r.expense_report_id DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countExpenseListWithFilters" resultType="long">
        SELECT COUNT(*)
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        <where>
            r.company_id = #{companyId}
            <if test="startDate != null">
                AND r.report_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND r.report_date &lt;= #{endDate}
            </if>
            <if test="minAmount != null">
                AND r.total_amount &gt;= #{minAmount}
            </if>
            <if test="maxAmount != null">
                AND r.total_amount &lt;= #{maxAmount}
            </if>
            <if test="statuses != null and statuses.size() > 0">
                AND r.status IN
                <foreach collection="statuses" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="category != null and category != ''">
                AND EXISTS (
                    SELECT 1 FROM expense_detail_tb d
                    WHERE d.expense_report_id = r.expense_report_id
                      AND d.category = #{category}
                )
            </if>
            <if test="taxProcessed != null">
                AND r.tax_processed = #{taxProcessed}
            </if>
            <if test="drafterName != null and drafterName != ''">
                AND u.korean_name LIKE CONCAT('%', #{drafterName}, '%')
            </if>
            <if test="paymentMethod != null and paymentMethod != ''">
                AND EXISTS (
                    SELECT 1 FROM expense_detail_tb d
                    WHERE d.expense_report_id = r.expense_report_id
                      AND d.payment_method = #{paymentMethod}
                      AND d.company_id = r.company_id
                )
            </if>
        </where>
    </select>

    <!-- 카테고리별 합계/건수 요약 (세무사용) -->
    <select id="selectCategorySummary" resultType="com.innersignature.backend.dto.CategorySummaryDto">
        SELECT
            d.category AS category,
            COALESCE(SUM(COALESCE(d.actual_paid_amount, d.amount)), 0) AS totalAmount,
            COUNT(*) AS itemCount,
            COUNT(DISTINCT d.expense_report_id) AS reportCount
        FROM expense_detail_tb d
        JOIN expense_report_tb r ON d.expense_report_id = r.expense_report_id
        <where>
            r.company_id = #{companyId}
            <if test="startDate != null">
                AND r.report_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND r.report_date &lt;= #{endDate}
            </if>
            <if test="statuses != null and statuses.size() > 0">
                AND r.status IN
                <foreach collection="statuses" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="taxProcessed != null">
                AND r.tax_processed = #{taxProcessed}
            </if>
        </where>
        GROUP BY d.category
        ORDER BY totalAmount DESC
    </select>

    <select id="selectExpenseReportById" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT 
            r.*, 
            u.korean_name AS drafterName 
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        WHERE r.expense_report_id = #{expenseReportId}
        AND r.company_id = #{companyId}
    </select>

    <select id="selectExpenseDetails" resultType="com.innersignature.backend.dto.ExpenseDetailDto">
        SELECT 
            expense_detail_id,
            expense_report_id,
            category,
            merchant_name,
            description,
            amount,
            actual_paid_amount,
            payment_method,
            payment_req_date,
            card_number,
            is_pre_approval,
            note,
            is_tax_deductible,
            non_deductible_reason,
            company_id
        FROM expense_detail_tb
        WHERE expense_report_id = #{expenseReportId}
        AND company_id = #{companyId}
    </select>

    <!-- 배치 조회: 여러 expense_report_id의 상세 항목을 한 번에 조회 -->
    <select id="selectExpenseDetailsBatch" resultType="com.innersignature.backend.dto.ExpenseDetailDto">
        SELECT * FROM expense_detail_tb
        WHERE company_id = #{companyId}
        AND expense_report_id IN
        <foreach collection="expenseReportIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY expense_report_id, expense_detail_id
    </select>

    <select id="selectApprovalLines" resultType="com.innersignature.backend.dto.ApprovalLineDto">
        SELECT 
            al.*,
            u.korean_name AS approverName,
            uc.position AS approverPosition
        FROM approval_line_tb al
        JOIN user_tb u ON al.approver_id = u.user_id
        JOIN user_company_tb uc ON al.approver_id = uc.user_id AND al.company_id = uc.company_id
        WHERE al.expense_report_id = #{expenseReportId}
        AND al.company_id = #{companyId}
        ORDER BY al.step_order ASC
    </select>

    <update id="updateApprovalLine">
        UPDATE approval_line_tb
        SET
            status = 'APPROVED',
            signature_data = #{approvalLineDto.signatureData},
            approval_date = NOW()
        WHERE
            expense_report_id = #{approvalLineDto.expenseReportId}
            AND approver_id = #{approvalLineDto.approverId}
            AND company_id = #{companyId}
    </update>

    <update id="rejectApprovalLine">
        UPDATE approval_line_tb
        SET
            status = 'REJECTED',
            rejection_reason = #{approvalLineDto.rejectionReason},
            approval_date = NOW()
        WHERE
            expense_report_id = #{approvalLineDto.expenseReportId}
            AND approver_id = #{approvalLineDto.approverId}
            AND company_id = #{companyId}
    </update>

    <update id="cancelApprovalLine">
        UPDATE approval_line_tb
        SET
            status = 'WAIT',
            signature_data = NULL,
            approval_date = NULL
        WHERE
            expense_report_id = #{approvalLineDto.expenseReportId}
            AND approver_id = #{approvalLineDto.approverId}
            AND company_id = #{companyId}
    </update>

    <update id="cancelRejectionLine">
        UPDATE approval_line_tb
        SET
            status = 'WAIT',
            rejection_reason = NULL,
            approval_date = NULL
        WHERE
            expense_report_id = #{approvalLineDto.expenseReportId}
            AND approver_id = #{approvalLineDto.approverId}
            AND company_id = #{companyId}
    </update>

    <update id="updateExpenseReportStatus">
        UPDATE expense_report_tb
        SET status = #{status}
        WHERE expense_report_id = #{expenseReportId}
        AND company_id = #{companyId}
    </update>

    <update id="updateExpenseReportStatusWithPayment">
        UPDATE expense_report_tb
        SET status = #{status},
            actual_paid_amount = #{actualPaidAmount},
            amount_difference_reason = #{amountDifferenceReason}
        WHERE expense_report_id = #{expenseReportId}
        AND company_id = #{companyId}
    </update>

    <insert id="insertExpenseReport" useGeneratedKeys="true" keyProperty="expenseReportId">
        INSERT INTO expense_report_tb (
            drafter_id,
            report_date,
            title,
            total_amount,
            status,
            payment_req_date,
            is_pre_approval,
            company_id
        ) VALUES (
            #{drafterId},
            #{reportDate},
            #{title},
            #{totalAmount},
            #{status, jdbcType=VARCHAR},
            #{paymentReqDate},
            #{isPreApproval, jdbcType=TINYINT},
            #{companyId}
        )
    </insert>

    <update id="updateExpenseReport">
        UPDATE expense_report_tb
        SET
            report_date = #{expenseReportDto.reportDate},
            total_amount = #{expenseReportDto.totalAmount},
            payment_req_date = #{expenseReportDto.paymentReqDate},
            is_pre_approval = #{expenseReportDto.isPreApproval, jdbcType=TINYINT}
        WHERE
            expense_report_id = #{expenseReportDto.expenseReportId}
            AND company_id = #{companyId}
    </update>

    <insert id="insertExpenseDetail">
        INSERT INTO expense_detail_tb (
            expense_report_id,
            category,
            merchant_name,
            description,
            amount,
            actual_paid_amount,
            payment_method,
            payment_req_date,
            card_number,
            is_pre_approval,
            note,
            company_id
        ) VALUES (
            #{expenseReportId},
            #{category},
            #{merchantName},
            #{description},
            #{amount},
            #{actualPaidAmount},
            #{paymentMethod},
            #{paymentReqDate},
            #{cardNumber},
            #{isPreApproval, jdbcType=TINYINT},
            #{note},
            #{companyId}
        )
    </insert>

    <delete id="deleteExpenseDetails">
        DELETE FROM expense_detail_tb
        WHERE expense_report_id = #{expenseReportId}
        AND company_id = #{companyId}
    </delete>

    <insert id="insertApprovalLine">
        INSERT INTO approval_line_tb (
            expense_report_id,
            approver_id,
            step_order,
            status,
            approval_date,
            signature_data,
            rejection_reason,
            company_id
        ) VALUES (
            #{expenseReportId},
            #{approverId},
            #{stepOrder},
            #{status, jdbcType=VARCHAR},
            #{approvalDate},
            #{signatureData},
            #{rejectionReason},
            #{companyId}
        )
    </insert>

    <delete id="deleteApprovalLines">
        DELETE FROM approval_line_tb
        WHERE expense_report_id = #{expenseReportId}
        AND company_id = #{companyId}
    </delete>

    <!-- 결재 라인 전체 초기화 (세무 수정 요청 시 사용) -->
    <update id="resetApprovalLinesForReport">
        UPDATE approval_line_tb
        SET
            status = 'WAIT',
            signature_data = NULL,
            approval_date = NULL,
            rejection_reason = NULL
        WHERE expense_report_id = #{expenseReportId}
          AND company_id = #{companyId}
    </update>

    <delete id="deleteExpenseReport">
        DELETE FROM expense_report_tb
        WHERE expense_report_id = #{expenseReportId}
        AND company_id = #{companyId}
    </delete>

    <select id="selectPendingApprovalsByUserId" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT DISTINCT
            r.*,
            u.korean_name AS drafterName,
            (SELECT d.description
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != ''
             ORDER BY d.expense_detail_id ASC
             LIMIT 1) AS firstDescription,
            (SELECT COUNT(*)
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != '') AS descriptionCount
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        JOIN approval_line_tb al ON r.expense_report_id = al.expense_report_id
        WHERE al.approver_id = #{userId}
          AND al.status = 'WAIT'
          AND r.status != 'REJECTED'
          AND r.company_id = #{companyId}
        ORDER BY r.expense_report_id DESC
    </select>

    <!-- 내가 결재했던 문서 조회: APPROVED/REJECTED 이력 -->
    <select id="selectMyApprovedReportsByUserId" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT DISTINCT
            r.*,
            u.korean_name AS drafterName,
            (SELECT d.description
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != ''
             ORDER BY d.expense_detail_id ASC
             LIMIT 1) AS firstDescription,
            (SELECT COUNT(*)
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != '') AS descriptionCount
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        JOIN approval_line_tb al ON r.expense_report_id = al.expense_report_id
        WHERE al.approver_id = #{userId}
          AND al.status IN ('APPROVED', 'REJECTED')
          AND r.company_id = #{companyId}
        ORDER BY r.expense_report_id DESC
    </select>

    <!-- 영수증 목록 조회 -->
    <select id="selectReceiptsByExpenseReportId" resultType="com.innersignature.backend.dto.ReceiptDto">
        SELECT 
            r.*,
            u.korean_name AS uploadedByName
        FROM receipt_tb r
        JOIN user_tb u ON r.uploaded_by = u.user_id
        WHERE r.expense_report_id = #{expenseReportId}
        AND r.company_id = #{companyId}
        ORDER BY r.uploaded_at DESC
    </select>

    <!-- 영수증 저장 -->
    <insert id="insertReceipt" useGeneratedKeys="true" keyProperty="receiptId">
        INSERT INTO receipt_tb (
            expense_report_id,
            file_path,
            original_filename,
            file_size,
            uploaded_by,
            uploaded_at,
            company_id
        ) VALUES (
            #{expenseReportId},
            #{filePath},
            #{originalFilename},
            #{fileSize},
            #{uploadedBy},
            #{uploadedAt},
            #{companyId}
        )
    </insert>

    <!-- 영수증 삭제 -->
    <delete id="deleteReceipt">
        DELETE FROM receipt_tb
        WHERE receipt_id = #{receiptId}
        AND company_id = #{companyId}
    </delete>

    <!-- 영수증 조회 (단건) -->
    <select id="selectReceiptById" resultType="com.innersignature.backend.dto.ReceiptDto">
        SELECT 
            r.*,
            u.korean_name AS uploadedByName
        FROM receipt_tb r
        JOIN user_tb u ON r.uploaded_by = u.user_id
        WHERE r.receipt_id = #{receiptId}
        AND r.company_id = #{companyId}
    </select>

    <!-- 세무처리 완료 업데이트 -->
    <update id="updateTaxProcessed">
        UPDATE expense_report_tb
        SET tax_processed = #{taxProcessed},
            tax_processed_at = #{taxProcessedAt}
        WHERE expense_report_id = #{expenseReportId}
        AND company_id = #{companyId}
    </update>

    <!-- 세무 수집 대상 건 조회 (APPROVED 상태의 모든 문서, 수집 여부와 관계없이) -->
    <select id="selectTaxPendingCollection" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT 
            r.expense_report_id,
            r.drafter_id,
            r.report_date,
            r.title,
            r.total_amount,
            r.status,
            r.tax_collected_at,
            r.tax_collected_by,
            r.tax_revision_requested,
            r.tax_revision_request_reason,
            u.korean_name AS drafter_name
        FROM expense_report_tb r
        LEFT JOIN user_tb u ON r.drafter_id = u.user_id
        WHERE r.company_id = #{companyId}
            AND r.status = 'APPROVED'
        <if test="startDate != null">
            AND r.report_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND r.report_date &lt;= #{endDate}
        </if>
        ORDER BY r.report_date DESC, r.expense_report_id DESC
    </select>

    <!-- 세무 수집 업데이트 -->
    <update id="updateTaxCollected">
        UPDATE expense_report_tb
        SET tax_collected_at = #{taxCollectedAt},
            tax_collected_by = #{taxCollectedBy}
        WHERE expense_report_id = #{expenseReportId}
            AND company_id = #{companyId}
    </update>

    <!-- 세무 수정 요청 업데이트 -->
    <update id="updateTaxRevisionRequest">
        UPDATE expense_report_tb
        SET tax_revision_requested = #{taxRevisionRequested},
            tax_revision_request_reason = #{taxRevisionRequestReason}
        WHERE expense_report_id = #{expenseReportId}
            AND company_id = #{companyId}
    </update>

    <!-- 대시보드 전체 요약 통계 조회 -->
    <select id="selectDashboardStats" resultType="com.innersignature.backend.dto.DashboardStatsDto">
        SELECT 
            COALESCE(SUM(COALESCE(actual_paid_amount, total_amount)), 0) AS totalAmount,
            COUNT(*) AS totalCount,
            COALESCE(AVG(COALESCE(actual_paid_amount, total_amount)), 0) AS averageAmount,
            COALESCE(MAX(COALESCE(actual_paid_amount, total_amount)), 0) AS maxAmount,
            COALESCE(MIN(COALESCE(actual_paid_amount, total_amount)), 0) AS minAmount,
            SUM(CASE WHEN status = 'PENDING' THEN 1 ELSE 0 END) AS pendingCount
        FROM expense_report_tb
        <where>
            company_id = #{companyId}
            <if test="startDate != null">
                AND report_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND report_date &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- 월별 지출 추이 조회 -->
    <select id="selectMonthlyTrend" resultType="com.innersignature.backend.dto.MonthlyTrendDto">
        SELECT
            DATE_FORMAT(report_date, '%Y-%m') AS yearMonth,
            COALESCE(SUM(COALESCE(actual_paid_amount, total_amount)), 0) AS totalAmount
        FROM expense_report_tb
        <where>
            company_id = #{companyId}
            <if test="startDate != null">
                AND report_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND report_date &lt;= #{endDate}
            </if>
        </where>
        GROUP BY DATE_FORMAT(report_date, '%Y-%m')
        ORDER BY yearMonth ASC
    </select>

    <!-- 상태별 통계 조회 -->
    <select id="selectStatusStats" resultType="com.innersignature.backend.dto.StatusStatsDto">
        SELECT
            status,
            COUNT(*) AS count,
            COALESCE(SUM(COALESCE(actual_paid_amount, total_amount)), 0) AS totalAmount
        FROM expense_report_tb
        <where>
            company_id = #{companyId}
            <if test="startDate != null">
                AND report_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND report_date &lt;= #{endDate}
            </if>
        </where>
        GROUP BY status
        ORDER BY count DESC
    </select>

    <!-- 사용자별 지출 합계 조회 -->
    <select id="selectUserExpenseStats" resultType="com.innersignature.backend.dto.UserExpenseStatsDto">
        SELECT
            u.user_id AS userId,
            u.korean_name AS userName,
            COALESCE(SUM(COALESCE(r.actual_paid_amount, r.total_amount)), 0) AS totalAmount
        FROM user_tb u
        LEFT JOIN expense_report_tb r ON u.user_id = r.drafter_id
            AND r.company_id = #{companyId}
            <if test="startDate != null">
                AND r.report_date >= #{startDate}
            </if>
            <if test="endDate != null">
                AND r.report_date &lt;= #{endDate}
            </if>
        WHERE u.company_id = #{companyId}
        GROUP BY u.user_id, u.korean_name
        ORDER BY totalAmount DESC
    </select>

    <!-- 카테고리별 비율 조회 -->
    <select id="selectCategoryRatio" resultType="com.innersignature.backend.dto.CategoryRatioDto">
        SELECT 
            d.category AS category,
            COALESCE(SUM(COALESCE(d.actual_paid_amount, d.amount)), 0) AS amount,
            0.0 AS ratio
        FROM expense_detail_tb d
        JOIN expense_report_tb r ON d.expense_report_id = r.expense_report_id
        <where>
            r.company_id = #{companyId}
            <if test="startDate != null">
                AND r.report_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND r.report_date &lt;= #{endDate}
            </if>
        </where>
        GROUP BY d.category
        ORDER BY amount DESC
    </select>

    <!-- 세무처리 대기 건 조회 (APPROVED 상태이지만 taxProcessed=false) -->
    <select id="selectTaxPendingReports" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT 
            r.*, 
            u.korean_name AS drafterName,
            (SELECT d.description
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != ''
             ORDER BY d.expense_detail_id ASC
             LIMIT 1) AS firstDescription,
            (SELECT COUNT(*)
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != '') AS descriptionCount
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        WHERE r.status = 'APPROVED' 
          AND (r.tax_processed = 0 OR r.tax_processed IS NULL)
          AND r.company_id = #{companyId}
        <if test="startDate != null">
            AND r.report_date &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND r.report_date &lt;= #{endDate}
        </if>
        ORDER BY r.report_date DESC, r.expense_report_id DESC
    </select>

    <!-- 세무처리 현황 통계 조회 -->
    <select id="selectTaxStatus" resultType="com.innersignature.backend.dto.TaxStatusDto">
        SELECT 
            COUNT(*) AS totalCount,
            SUM(CASE WHEN (tax_processed = 0 OR tax_processed IS NULL) THEN 1 ELSE 0 END) AS pendingCount,
            SUM(CASE WHEN tax_processed = 1 THEN 1 ELSE 0 END) AS completedCount,
            CASE 
                WHEN COUNT(*) > 0 THEN 
                    CAST(SUM(CASE WHEN tax_processed = 1 THEN 1 ELSE 0 END) AS DECIMAL) / COUNT(*)
                ELSE 0.0 
            END AS completionRate,
            COALESCE(SUM(COALESCE(actual_paid_amount, total_amount)), 0) AS totalAmount,
            COALESCE(SUM(CASE WHEN (tax_processed = 0 OR tax_processed IS NULL) THEN COALESCE(actual_paid_amount, total_amount) ELSE 0 END), 0) AS pendingAmount,
            COALESCE(SUM(CASE WHEN tax_processed = 1 THEN COALESCE(actual_paid_amount, total_amount) ELSE 0 END), 0) AS completedAmount
        FROM expense_report_tb
        WHERE status = 'APPROVED'
        AND company_id = #{companyId}
        <if test="startDate != null">
            AND report_date &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND report_date &lt;= #{endDate}
        </if>
    </select>

    <!-- 월별 세무처리 집계 조회 -->
    <select id="selectMonthlyTaxSummary" resultType="com.innersignature.backend.dto.MonthlyTaxSummaryDto">
        SELECT 
            DATE_FORMAT(report_date, '%Y-%m') AS yearMonth,
            SUM(CASE WHEN tax_processed = 1 THEN 1 ELSE 0 END) AS completedCount,
            COALESCE(SUM(COALESCE(actual_paid_amount, total_amount)), 0) AS totalAmount,
            COALESCE(SUM(CASE WHEN tax_processed = 1 THEN COALESCE(actual_paid_amount, total_amount) ELSE 0 END), 0) AS completedAmount
        FROM expense_report_tb
        WHERE status = 'APPROVED'
        AND company_id = #{companyId}
        <if test="startDate != null">
            AND report_date &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND report_date &lt;= #{endDate}
        </if>
        GROUP BY DATE_FORMAT(report_date, '%Y-%m')
        ORDER BY yearMonth ASC
    </select>

    <!-- SUPERADMIN 전용: 회사별 지출결의서 목록 조회 (companyId가 null이면 전체 조회) -->
    <select id="selectExpenseListForSuperAdmin" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT 
            r.*, 
            u.korean_name AS drafterName,
            c.company_name AS companyName,
            (SELECT d.description
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != ''
             ORDER BY d.expense_detail_id ASC
             LIMIT 1) AS firstDescription,
            (SELECT COUNT(*)
             FROM expense_detail_tb d
             WHERE d.expense_report_id = r.expense_report_id
               AND d.company_id = r.company_id
               AND d.description IS NOT NULL
               AND TRIM(d.description) != '') AS descriptionCount
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        LEFT JOIN company_tb c ON r.company_id = c.company_id
        <where>
            <if test="companyId != null">
                r.company_id = #{companyId}
            </if>
            <if test="startDate != null">
                AND r.report_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND r.report_date &lt;= #{endDate}
            </if>
            <if test="minAmount != null">
                AND r.total_amount &gt;= #{minAmount}
            </if>
            <if test="maxAmount != null">
                AND r.total_amount &lt;= #{maxAmount}
            </if>
            <if test="statuses != null and statuses.size() > 0">
                AND r.status IN
                <foreach collection="statuses" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="category != null and category != ''">
                AND EXISTS (
                    SELECT 1 FROM expense_detail_tb d
                    WHERE d.expense_report_id = r.expense_report_id
                      AND d.category = #{category}
                )
            </if>
            <if test="taxProcessed != null">
                AND r.tax_processed = #{taxProcessed}
            </if>
            <if test="drafterName != null and drafterName != ''">
                AND u.korean_name LIKE CONCAT('%', #{drafterName}, '%')
            </if>
        </where>
        ORDER BY r.expense_report_id DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- SUPERADMIN 전용: 회사별 지출결의서 개수 조회 (companyId가 null이면 전체 조회) -->
    <select id="countExpenseListForSuperAdmin" resultType="long">
        SELECT COUNT(*)
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        <where>
            <if test="companyId != null">
                r.company_id = #{companyId}
            </if>
            <if test="startDate != null">
                AND r.report_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND r.report_date &lt;= #{endDate}
            </if>
            <if test="minAmount != null">
                AND r.total_amount &gt;= #{minAmount}
            </if>
            <if test="maxAmount != null">
                AND r.total_amount &lt;= #{maxAmount}
            </if>
            <if test="statuses != null and statuses.size() > 0">
                AND r.status IN
                <foreach collection="statuses" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="category != null and category != ''">
                AND EXISTS (
                    SELECT 1 FROM expense_detail_tb d
                    WHERE d.expense_report_id = r.expense_report_id
                      AND d.category = #{category}
                )
            </if>
            <if test="taxProcessed != null">
                AND r.tax_processed = #{taxProcessed}
            </if>
            <if test="drafterName != null and drafterName != ''">
                AND u.korean_name LIKE CONCAT('%', #{drafterName}, '%')
            </if>
        </where>
    </select>

    <!-- SUPERADMIN 전용: 지출결의서 상세 조회 (companyId가 null이어도 조회 가능) -->
    <select id="selectExpenseReportByIdForSuperAdmin" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT 
            r.*, 
            u.korean_name AS drafterName,
            c.company_name AS companyName
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        LEFT JOIN company_tb c ON r.company_id = c.company_id
        WHERE r.expense_report_id = #{expenseReportId}
    </select>

    <!-- SUPERADMIN 전용: 지출 상세 항목 조회 (companyId 제약 없음) -->
    <select id="selectExpenseDetailsForSuperAdmin" resultType="com.innersignature.backend.dto.ExpenseDetailDto">
        SELECT * FROM expense_detail_tb
        WHERE expense_report_id = #{expenseReportId}
    </select>

    <!-- SUPERADMIN 전용: 결재 라인 조회 (companyId 제약 없음) -->
    <select id="selectApprovalLinesForSuperAdmin" resultType="com.innersignature.backend.dto.ApprovalLineDto">
        SELECT 
            al.*,
            u.korean_name AS approverName,
            uc.position AS approverPosition
        FROM approval_line_tb al
        LEFT JOIN user_tb u ON al.approver_id = u.user_id
        LEFT JOIN user_company_tb uc ON al.approver_id = uc.user_id AND al.company_id = uc.company_id
        WHERE al.expense_report_id = #{expenseReportId}
        ORDER BY al.step_order ASC
    </select>

    <!-- SUPERADMIN 전용: 영수증 조회 (companyId 제약 없음) -->
    <select id="selectReceiptsByExpenseReportIdForSuperAdmin" resultType="com.innersignature.backend.dto.ReceiptDto">
        SELECT 
            r.*,
            u.korean_name AS uploadedByName
        FROM receipt_tb r
        JOIN user_tb u ON r.uploaded_by = u.user_id
        WHERE r.expense_report_id = #{expenseReportId}
        ORDER BY r.uploaded_at DESC
    </select>

    <!-- 증빙 누락 건 조회: 영수증이 없거나 작성일이 오래된 건 (최적화 버전) -->
    <select id="selectMissingReceipts" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT
            r.*,
            u.korean_name AS drafterName,
            d.firstDescription,
            d.descriptionCount
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        LEFT JOIN (
            SELECT
                d.expense_report_id,
                MIN(CASE WHEN d.description IS NOT NULL AND TRIM(d.description) != '' THEN d.description END) AS firstDescription,
                COUNT(CASE WHEN d.description IS NOT NULL AND TRIM(d.description) != '' THEN 1 END) AS descriptionCount
            FROM expense_detail_tb d
            WHERE d.description IS NOT NULL AND TRIM(d.description) != ''
            GROUP BY d.expense_report_id
        ) d ON r.expense_report_id = d.expense_report_id
        LEFT JOIN receipt_tb rec ON r.expense_report_id = rec.expense_report_id
        WHERE r.company_id = #{companyId}
          AND r.report_date &lt;= #{cutoffDate}
          AND r.status IN ('WAIT', 'APPROVED')
          AND rec.receipt_id IS NULL
        ORDER BY r.report_date ASC, r.expense_report_id ASC
    </select>

    <!-- 상세 항목의 부가세 공제 정보 업데이트 -->
    <update id="updateExpenseDetailTaxInfo">
        UPDATE expense_detail_tb
        SET
            is_tax_deductible = #{isTaxDeductible},
            non_deductible_reason = #{nonDeductibleReason}
        WHERE expense_detail_id = #{expenseDetailId}
          AND company_id = #{companyId}
    </update>

    <!-- 상세 항목의 실제 지급 금액 업데이트 -->
    <update id="updateExpenseDetailActualPaidAmount">
        UPDATE expense_detail_tb
        SET
            actual_paid_amount = #{actualPaidAmount}
        WHERE expense_detail_id = #{expenseDetailId}
          AND company_id = #{companyId}
    </update>

    <!-- 상세 항목의 결제수단 업데이트 -->
    <update id="updateExpenseDetailPaymentMethod">
        UPDATE expense_detail_tb
        SET
            payment_method = #{paymentMethod}
        WHERE expense_detail_id = #{expenseDetailId}
          AND company_id = #{companyId}
    </update>

    <update id="updateExpenseDetail">
        UPDATE expense_detail_tb
        SET
            category = #{category},
            merchant_name = #{merchantName},
            description = #{description},
            amount = #{amount},
            actual_paid_amount = #{actualPaidAmount},
            payment_method = #{paymentMethod},
            payment_req_date = #{paymentReqDate},
            card_number = #{cardNumber},
            is_pre_approval = #{isPreApproval, jdbcType=TINYINT},
            note = #{note},
            is_tax_deductible = #{isTaxDeductible, jdbcType=TINYINT},
            non_deductible_reason = #{nonDeductibleReason}
        WHERE expense_detail_id = #{expenseDetailId}
          AND company_id = #{companyId}
    </update>

    <!-- 세무 수정 요청 건 조회: 작성자 기준 -->
    <select id="selectTaxRevisionRequestsByDrafter" resultType="com.innersignature.backend.dto.ExpenseReportDto">
        SELECT
            r.*,
            u.korean_name AS drafterName
        FROM expense_report_tb r
        JOIN user_tb u ON r.drafter_id = u.user_id
        WHERE r.company_id = #{companyId}
          AND r.drafter_id = #{userId}
          AND r.tax_revision_requested = 1
        ORDER BY r.expense_report_id DESC
    </select>

</mapper>