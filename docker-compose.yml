
# 3개의 서비스를 정의합니다
services:
  # MySQL 데이터베이스
  mysql:
    image: mysql:8.0  # MySQL 8.0 이미지 사용
    container_name: innersignature-mysql
    environment:
      MYSQL_ROOT_PASSWORD: 1q2w3e4r!  # 루트 비밀번호
      MYSQL_DATABASE: signature        # 데이터베이스 이름
  
    ports:
      - "3306:3306"  # 호스트의 3306 포트를 컨테이너의 3306 포트로 연결
    volumes:
      - mysql_data:/var/lib/mysql  # 데이터 영구 저장
      - ./database:/docker-entrypoint-initdb.d  # 초기 SQL 스크립트 실행
    networks:
      - innersignature-network
    healthcheck:  # DB가 준비될 때까지 대기
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p1q2w3e4r!"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 백엔드 서버
  backend:
    build:
      context: ./backend  # backend 폴더에서 Dockerfile 찾기
      dockerfile: Dockerfile
    container_name: innersignature-backend
    environment:
      SPRING_PROFILES_ACTIVE: dev
      DB_HOST: mysql  # ⭐ 중요: localhost가 아니라 'mysql' (도커 서비스 이름)
      DB_PORT: 3306
      DB_NAME: signature
      DB_USERNAME: root
      DB_PASSWORD: 1q2w3e4r!
      JWT_SECRET: c206e4d5a5fb9c12c6e4615f6ffc9128185b3e35085b212acd2c53dd9c531702
      FRONTEND_URL: http://localhost:5173
    ports:
      - "8080:8080"  # 호스트의 8080 포트를 컨테이너의 8080 포트로 연결
    volumes:
      - ./backend/uploads:/app/uploads  # 업로드 파일 영구 저장
    depends_on:
      mysql:
        condition: service_healthy  # MySQL이 준비된 후에 실행
    networks:
      - innersignature-network

  # 프론트엔드 서버
  frontend:
    build:
      context: ./frontend  # frontend 폴더에서 Dockerfile 찾기
      dockerfile: Dockerfile
    container_name: innersignature-frontend
    ports:
      - "5173:80"  # 호스트의 5173 포트를 컨테이너의 80 포트로 연결
    depends_on:
      - backend  # 백엔드가 시작된 후에 실행
    networks:
      - innersignature-network

# 네트워크 정의 (같은 네트워크에 있어야 서로 통신 가능)
networks:
  innersignature-network:
    driver: bridge

# 볼륨 정의 (데이터 영구 저장)
volumes:
  mysql_data:
